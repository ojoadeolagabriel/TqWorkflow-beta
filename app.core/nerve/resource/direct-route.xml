<?xml version="1.0" encoding="utf-8" ?>
<container>

  <bean id="cacheType" class="app.core.nerve.utility.CacheType"/>

  <bean id="config" class="app.core.nerve.utility.Configuration">
    <property key="ESBJWTSharedKey" value="GQDstcKsx0NHjPOuXOYg5MbeJ1XT0uFiwDVvVBrk"/>
    <property key="ServerPort" value="9800"/>
    <property key="AmqTestPort" value="61616"/>
    <property key="HttpTestPort" value="9888"/>
    <property key="SocketTimeOut" value="6000"/>
    <property key="CacheType" value="{{cacheType}}"/>
  </bean>

  <bean id="dbLogProvider" class="app.core.nerve.test.DbLogProvider">
    <property key="ConnectionString" value="{{config.LocalConnectionString}}"/>
  </bean>
  
  <bean id="testProcessor" class="app.core.nerve.test.CouchDbTestProcessor"/>

  <context logProvider="dbLogProvider">

    <route>
      <from uri="mina:127.0.0.1?port={{config.ServerPort}};timeout={{config.SocketTimeOut}}"/>
    </route>

    <route>
      <from uri="direct:firstInstitutionDirect"/>
      <to uri="log2:{{config.DefaultLogPathRoot}}\firstInstitutionDirect.log?logType=file"/>
    </route>

    <route>
      <from uri="seda:firstSedaInstitutionDirect"/>
      <to uri="log2:{{config.DefaultLogPathRoot}}\open-weather-result-seda.log?logType=file;provider=dbLogProvider"/>
    </route>

    <route>
      <from uri="http:127.0.0.1?port={{config.HttpTestPort}};initialDelay=1000;path=testserver"/>
      <to uri="xmltojson:Processor?reverse=false"/>
      <to uri="jwt:httpToken?username=adeola.ojo;role=admin;iss=isw;sharedKey={{config.ESBJWTSharedKey}}"/>

      <loop>
        <expression>4</expression>
        <to uri="log2:{{config.DefaultLogPathRoot}}\http-soap-component.log?logType=file"/>
      </loop>      
      
    </route>

    <route>

      <from uri="timer:opeTimer?poll=10000;"/>
      <to uri="openweather:http://api.openweathermap.org/data/2.5/weather?location=lagos"/>
      <setHeader headerName="CamelHttpMethod" value="GET"/>

      <choice>
        <when>
          <method bean="testProcessor" method="IsGood"/>
          <to uri="seda:firstSedaInstitutionDirect?size=10;concurrentConsumers=true"/>
        </when>
      </choice>
      <process ref="testProcessor"/>
      <to uri="couchdb:127.0.0.1?port=5984;createDb=true"/>
      <to uri="smtp:127.0.0.1?port=25;protocol=smtp;contenttype=html;from=killerbeans@paydirect.com;to=testclient@127.0.0.1;subject=cannot see me"/>

    </route>
  </context>

</container>